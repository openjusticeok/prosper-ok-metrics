---
title: "`r paste0(if (isTRUE(params$draft)) '[DRAFT, NOT FOR EXTERNAL SHARING] ' else '', 'ProsperOK Metrics Report<br>for Tulsa Countys Prison Population,<br> Q4 2025')`"
subtitle: |
  November 2025 update on Tulsa County Prison Population and Sentences
format:
  ojo-report-template-html:
    theme: default
    mainfont: "Lora"
    header-includes: |
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Lato:wght@100;300;400;900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Lato:wght@100;300;400;900&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
# Formatting options -----------------------------------------------------------
logo: "www/okpi-square.png" # Other options are in the /www/ directory
number-sections: true
smooth-scroll: true
title-block-banner: "#2f507f" # The background color for the header banner
title-block-banner-color: "white" # The text color for the header banner
fontcolor: "black" # Default text color for the body
linkcolor: "black" # Default link color for the body
toc: true # This should be 'false' if your end goal is a PDF
knitr:
  opts_chunk:
    fig.align: center
    echo: false
    message: false
    warning: false
    fig-width: 7
    fig-height: 5
    out-width: '100%'
# Document info ----------------------------------------------------------------
author: Anthony Flores
date: last-modified
description: |
    This is a status update report using data from the Tulsa County Prison. It was prepared and analyzed by the Oklahoma Policy Institute.
embed-resources: false
params:
  audience: "internal"
  draft: true
# abstract-title: Publication Note
# abstract: 'DRAFT REPORT -- NOT FOR PUBLICATION'
---

```{r draft-disclaimer, echo=FALSE, results='asis'}
if (isTRUE(params$draft)) {
  cat("::: {.callout-warning}\n**[DRAFT, NOT FOR EXTERNAL SHARING]** This draft report is for internal use only.\n:::\n\n")
}
```

```{r}

# To render to PDF after you've rendered your .html document:
# pagedown::chrome_print("./report.html", "./report.pdf", format = "pdf")

# We'll build this into the YAML header so you don't have to take this extra step
# once the {pagedown} people get around to adding quarto support.
```

```{r setup, include=FALSE}
library(here)
library(ojodb)
library(ojothemes)
library(janitor)
library(gt)
library(gtExtras)
library(tidyverse)
library(nanoparquet)
library(ggrepel)

ojothemes::ojo_set_theme(theme = "okpi")

analysis_path <- here::here("data", "output", "prison_analysis_results.rds")
figures_path <- here::here("data", "output", "prison_figures.rds")

prison_analysis <- readRDS(analysis_path)
prison_figures <- readRDS(figures_path)

fmt_pct <- function(x) scales::percent(x, accuracy = 0.1)
fmt_num <- function(x) scales::comma(x, accuracy = 1)
audience <- match.arg(params$audience, c("internal", "external", "public"))
audience_show <- function(levels) audience %in% levels

# Load in the prison metrics data
# to be used in line for the narrative section
# TODO: feat(report): Filter/pull to only the INDIVIDUAL metrics used in this report
# WARNING: I'm considering moving this code to analyze_processsed_prison_data.R
# and turning each into a target object for locality of behavior and to simplify
# the pipeline. Either that or create a new R script to do this. The advantage
# of a new script is we don't have to run the whole prison_analysis.R script for
# each minor change. For now, we'll just pull from the big list object.
sentences_doc_admin_2025_total_tulsa  <- prison_analysis$sentences_doc_admin_year_total_by_county
releases_vera_admin_2024_total_tulsa  <- prison_analysis$releases_vera_admin_year_total_by_county
population_doc_admin_2025_yoy_by_gender_tulsa <- prison_analysis$population_doc_admin_yoy_by_gender_county
population_doc_admin_2025_by_gender_tulsa <- prison_analysis$population_doc_admin_year_by_gender_county
population_doc_admin_2024_by_gender_tulsa <- prison_analysis$population_doc_admin_year_by_gender_county
# Repeat if we need Oklahoma/other county data in the narrative
```

# Overview

This is an overview report to provide some basic numbers about the current
population and recent bookings at the Oklahoma County Detention Center (OCDC).

* Prison Sentences from those sentenced in Tulsa County
* Prison Releases from those sentenced in Tulsa County
* Prison Population by Gender from Tulsa County

{{< pagebreak >}}

# Prison Sentences

```{r prison-sentences-total}
#| include: !expr audience_show(c("internal", "external", "public"))
#| eval: !expr audience_show(c("internal", "external", "public"))

prison_figures$plot_sentences_doc_admin_year_total_by_county
```

# Prison Releases
- Mention we can't get data more recent thatn __ because we need the DSA with
DOC first.

```{r prison-releases-total}
#| include: !expr audience_show(c("internal", "external", "public"))
#| eval: !expr audience_show(c("internal", "external", "public"))

prison_figures$plot_releases_vera_admin_year_total_by_county
```

# Prison Population by Gender

```{r prison-population-total}
#| include: !expr audience_show(c("internal", "external", "public"))
#| eval: !expr audience_show(c("internal", "external", "public"))

# Dodge by county, group by total & gender
prison_figures$plot_population_doc_admin_year_by_gender_county
```

```{r prison-population-yoy}
#| include: !expr audience_show(c("internal", "external", "public"))
#| eval: !expr audience_show(c("internal", "external", "public"))

# Dodge by county, group by total & gender
prison_figures$plot_population_doc_admin_yoy_by_gender_county
```
