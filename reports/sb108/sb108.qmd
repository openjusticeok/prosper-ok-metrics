---
title: DRAFT - SB 108 Prospective Impact Analysis
subtitle: Open Justice Oklahoma
format:
  ojo-report-template-html: default
  pdf:
    pdf-engine: xelatex
author: Brancen Gregory
date: last-modified
logo: "www/ojo-logo-white.png"
number-sections: true
smooth-scroll: true
title-block-banner: "black"
title-block-banner-color: "white"
knitr:
  opts_chunk:
    fig.align: center
    echo: FALSE
    message: FALSE
    warning: FALSE
description: |
  An estimation of the number of individuals who would be impacted by SB 108 if enacted
abstract-title: "Executive Summary"
abstract: |
  Insert abstract
---

```{r, setup}
library(ojodb)
library(here)
library(readr)
library(stringr)
library(ggplot2)
library(gt)
library(lubridate)
library(tidyr)
library(purrr)

theme_set(ojo_theme())
```


## Introduction

Oklahoma's 2023 legislative session saw the introduction of SB 108. This bill, rolling back provisions of State Question 780, would make each additional conviction of possession of a controlled substance (excluding marijuana) a felony crime. While the punishment for a misdemeanor possession conviction is up to \$1,000 dollars and/or up to one year confinement, a felony conviction for the same crime can result in a fine of up to \$5,000 dollars and/or up to 5 years imprisonment.

This analysis uses historical data on convictions for possession of a controlled substance to better understand how prevalent the situation of having four or more convictions within 10 years is, and thereby, estimate the number of people who would be impacted by this legislation should it be enacted into law in a future legislative session.


## Data

```{r, load_data}
#| cache: true

# ojodb <- ojo_connect()
#
# data <- ojo_tbl("case", .con = ojodb) |>
#   select(
#     id,
#     district,
#     case_type,
#     date_filed,
#     date_closed,
#     created_at,
#     updated_at
#   ) |>
#   filter(
#     case_type %in% c("CM", "CF"),
#     date_filed >= "2001-01-01",
#     date_filed < "2023-01-01"
#   ) |>
#   left_join(
#     ojo_tbl("count", .con = ojodb),
#     by = c("id" = "case_id"),
#     suffix = c("", "_count")
#   ) |>
#   ojo_collect()
#
# write_csv(date, here("data/cm_cf_2001_2022.csv))

data <- read_csv(here("data/cm_cf_2001_2022.csv"))
disposition_predictions <- read_csv(here("data/toc-results/disposition_predictions.csv")) |>
  distinct()
uccs <- read_csv(here("data/toc-results/uccs-schema.csv"))
```


```{r, clean_data}
prepare <- function(x) {
  x |>
    str_to_upper() |>
    str_remove_all("^[A-Z0-9]{0,10},") |>
    str_remove_all("(?i)IN VIOLATION.*") |>
    str_remove_all(r"{\s*\([^\)]+\)}") |>
    str_replace_all("[[:punct:][:blank:]]+", " ") |>
    str_squish()
}

result_clean <- data |>
  # Cleaning data to match w/ cleaned lookup table
  mutate(
    count_as_filed = prepare(count_as_filed),
    # If count_as_disposed is missing, fill it with count_as_filed
    # This will retain
    count_as_disposed = if_else(
      is.na(count_as_disposed),
      count_as_filed,
      prepare(count_as_disposed)
    )
  ) |>
  left_join(
    disposition_predictions,
    by = c("count_as_disposed" = "disposition"),
    suffix = c("", "_toc"),
    relationship = "many-to-many"
  ) |>
  left_join(uccs, by = "uccs_code")
```

```{r, probability-distribution}
result_clean |>
  distinct(
    count_as_disposed,
    charge_desc,
    uccs_code,
    probability
  ) |>
  ggplot(aes(x = probability)) +
    geom_histogram() +
    geom_vline(aes(xintercept = 0.8), color = ojo_pal[5], linetype = "da")
```

```{r, filtered-data}
d <- result_clean |>
  select(
    id,
    case_type,
    date_filed,
    count_as_disposed,
    disposition_date,
    disposition,
    charge_desc,
    offense_category_desc,
    offense_type_desc,
    probability,
    uccs_code,
    party
  ) |>
  mutate(
    poss = str_detect(count_as_disposed, "(?i)poss"),
    dist = str_detect(count_as_disposed, "(?i)\\bdist"),
    intent = str_detect(count_as_disposed, "(?i)intent|\\bint\\b"),
    paraphernalia = str_detect(count_as_disposed, "(?i)paraph.*\\b"),
    weapon = str_detect(count_as_disposed, "(?i)weapon"),
    trafficking = str_detect(count_as_disposed, "(?i)traffick"),
    endeavor = str_detect(count_as_disposed, "(?i)endeavor|\\bend\\b"),
    wildlife = str_detect(count_as_disposed, "(?i)wildlife"),
    manufacture = str_detect(count_as_disposed, "(?i)\\bmanufac"),
    commercial = str_detect(count_as_disposed, "(?i)COMM FAC"),
    school_park_church = str_detect(count_as_disposed, "(?i)school|education|park|church|day care|\\spk\\s"),
    conspiracy = str_detect(count_as_disposed, "(?i)\\bconsp"),
    maintaining = str_detect(count_as_disposed, "(?i)\\bmaint.*(place|dwelling)"),
    tax = str_detect(count_as_disposed, "(?i)\\btax\\b"),
    minor = str_detect(count_as_disposed, "(?i)minor|child|under.*21"),
    inmate = str_detect(count_as_disposed, "(?i)inmate|jail|contrab|penal|\\bfac"),
    theft = str_detect(count_as_disposed, "(?i)larceny|theft|\\bstol(e|en)\\b"),
    vehicle = str_detect(count_as_disposed, "(?i)(?<!\\snon|not\\s)(?:\\sMV\\b|motor vehicle)"),
    proceeds = str_detect(count_as_disposed, "(?i)ac.*\\bp(r|o){0,2}|proceed"),
    drug = str_detect(count_as_disposed, "CDS|C\\.D\\.S|DRUG|OXY|HUFF|AMPHET|ZOLOL|ZOLAM|HYDROC|CODEIN|PRECURS|XANAX|MORPH|METERDI|ZEPAM|LORAZ|VALIU|EPHED|SUB|COCA|PSEUDO| CS|CS | CD|CD |\\bPRESCRIP|\\bNARC|\\bMETH|\\bC\\.D\\.|HEROIN|ANHYD|AMMONIA|OPIUM|LORTAB|\\bPARAPH\\b|\\bMA.*NA\\b|\\bMJ\\b|\\bMARI\\b"),
    uccs_drug = probability >= 0.8 & uccs_code >= 3090 & uccs_code <= 3162,
    uccs_drug_plus = probability >= 0.8 & uccs_code >= 3090 & uccs_code <= 3230
  ) |>
  arrange(count_as_disposed) |>
  filter(
    (uccs_drug_plus & !intent & !proceeds & !maintaining & !conspiracy & !school_park_church) |
      (poss & drug & !dist & !intent & !paraphernalia & !weapon & !trafficking &
         !endeavor & !wildlife & !manufacture & !commercial & !school_park_church &
         !conspiracy & !maintaining & !minor & !inmate & !vehicle & !proceeds)
  )
```

```{r, parties-data}
parties <- d |>
  left_join(
    ojo_tbl("party", .con = ojodb) |>
      filter(
        role == "Defendant",
        case_id %in% !!d$id
      ) |>
      distinct() |>
      ojo_collect(),
    by = c("party" = "id")
  )
```

### Source

Open Justice Oklahoma maintains a database of administrative court records which includes information on all criminal misdemeanors and felonies filed in Oklahoma beginning in 2001. Case information is systematically collected from publicly available data hosted on the [Oklahoma State Court Network (OSCN)](https://www.oscn.net/v4/) website.

### Methodology

This analysis looks statewide across all complete years of misdemeanors and felonies for charges of possession of a controlled substance. We then present the distribution of the number of convictions per person.

Our figures are likely to underestimate the total number of convictions by a relatively small but significant amount due to the expungement of records over time. The magnitude of this bias will be greater for earlier years, but can be roughly quantified by exploiting the court case id schema mandated by the Oklahoma Supreme Court.


## Results

```{r}
parties |>
  mutate(
    marijuana = str_detect(
      count_as_disposed,
      regex("\\bMA.*NA\\b|\\bMJ\\b|\\bMARI\\b", ignore_case = T)
    ),
    other = str_detect(
      count_as_disposed,
      "(?i)OXY|HUFF|AMPHET|ZOLOL|ZOLAM|HYDROC|CODEIN|PRECURS|XANAX|MORPH|METERDI|ZEPAM|LORAZ|VALIU|EPHED|COCA|PSEUDO|\\bPRESCRIP|\\bNARC|\\bMETH|HEROIN|ANHYD|AMMONIA|OPIUM|LORTAB|\\bPARAPH\\b|\\bOTHER\\b"
    )
  ) |>
  distinct(
    count_as_disposed,
    charge_desc,
    marijuana,
    other
  ) |>
  filter(
    marijuana,
    other
  )
```

```{r, conviction-count-plot}
parties |>
  drop_na(disposition) |>
  filter(str_detect(disposition, "(?i)dismiss|defer|convic")) |>
  group_by(oscn_id) |>
  count() |>
  mutate(
    n = if_else(
      n >= 4,
      4,
      n
    )
  ) |>
  ungroup() |>
  filter(n >= 2) |>
  ggplot(aes(x = n)) +
    scale_x_discrete() +
    stat_count() +
    geom_text(aes(label = after_stat(count)), stat = "count", vjust = -0.2)
```

```{r}
poi <- parties |>
  arrange(oscn_id, disposition_date) |>
  group_by(oscn_id) |>
  nest() |>
  mutate(
    rolling_10_year_n = map_int(
      data,
      ~ {
        .x$disposition_date |>
          as_tibble() |>
          mutate(
            lag_3_years = lag(value, 3)
          ) |>
          filter(
            interval(
              lag_3_years,
              value
            ) / years(1) <= 10
          ) |>
          nrow()
      }
    )
  ) |>
  filter(
    rolling_10_year_n > 0
  )
```

```{r}
poi |>
  unnest(cols = data) |>
  ungroup() |>
  distinct(count_as_disposed, charge_desc)
```


